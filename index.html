<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Request</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #212529; }
        .navbar { background: #000; color: #fff; padding: 1rem; margin-bottom: 2rem; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 24px rgba(0,0,0,0.06); }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #495057; }
        .btn-primary { background: #000; border: none; padding: 12px; border-radius: 8px; font-weight: 600; }
        .btn-primary:hover { background: #333; }
        .photo-box { background: #f1f3f5; border: 2px dashed #dee2e6; border-radius: 12px; padding: 15px; margin-bottom: 12px; transition: 0.3s; }
        .preview-img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; display: none; margin-right: 15px; border: 1px solid #dee2e6; }
        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner-border text-dark" role="status"></div>
    <div class="mt-2 fw-bold">Submitting Request...</div>
</div>

<nav class="navbar">
    <div class="container justify-content-center">
        <span class="navbar-brand mb-0 h1 text-white">RSSB (Bangkok) MAINTENANCE</span>
    </div>
</nav>

<div class="container mb-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card p-4">
                <form id="reqForm">
                    <div class="mb-3">
                        <label class="form-label">Reported By</label>
                        <input type="text" name="submittedBy" class="form-control" placeholder="Your full name" required>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Area</label>
                            <input type="text" name="area" class="form-control" placeholder="Kitchen" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Subarea</label>
                            <input type="text" name="subarea" class="form-control" placeholder="Sink" required>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Describe the Issue</label>
                        <textarea name="issue" class="form-control" rows="3" placeholder="Explain the problem..." required></textarea>
                    </div>

                    <label class="form-label">Photos (Up to 3)</label>
                    <div class="photo-box d-flex align-items-center">
                        <img id="p1" class="preview-img">
                        <input type="file" id="f1" class="form-control form-control-sm" accept="image/*" capture="environment" onchange="preview(1)">
                    </div>
                    <div class="photo-box d-flex align-items-center">
                        <img id="p2" class="preview-img">
                        <input type="file" id="f2" class="form-control form-control-sm" accept="image/*" capture="environment" onchange="preview(2)">
                    </div>
                    <div class="photo-box d-flex align-items-center mb-4">
                        <img id="p3" class="preview-img">
                        <input type="file" id="f3" class="form-control form-control-sm" accept="image/*" capture="environment" onchange="preview(3)">
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Submit Maintenance Request</button>
                </form>
                <div id="msg" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbye6jmWue-b9fGGPtiboJxa4m-2mNh9dRJ0BkvLTITOGOb0MCjGlDiXps4wQzNlRh6M/exec"; // PASTE YOUR URL HERE

    function preview(i) {
        const file = document.getElementById('f'+i).files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            const img = document.getElementById('p'+i);
            img.src = reader.result;
            img.style.display = 'block';
        };
        if (file) reader.readAsDataURL(file);
    }

    const readFile = (f) => new Promise(res => {
        if (!f) return res(null);
        const r = new FileReader();
        r.onload = e => res(e.target.result);
        r.readAsDataURL(f);
    });

    document.getElementById('reqForm').onsubmit = async (e) => {
        e.preventDefault();
        document.getElementById('loader').style.display = 'flex';
        
        try {
            const data = {
                action: "submitRequest",
                submittedBy: e.target.submittedBy.value,
                area: e.target.area.value,
                subarea: e.target.subarea.value,
                issue: e.target.issue.value,
                pic1: await readFile(document.getElementById('f1').files[0]),
                pic2: await readFile(document.getElementById('f2').files[0]),
                pic3: await readFile(document.getElementById('f3').files[0])
            };

            const resp = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(data) });
            const res = await resp.json();

            if (res.success) {
                document.getElementById('msg').innerHTML = `<div class="alert alert-success text-center">âœ… Request <b>#${res.reqNo}</b> Sent!</div>`;
                e.target.reset();
                document.querySelectorAll('.preview-img').forEach(img => img.style.display='none');
            }
        } catch (err) {
            alert("Submission failed. Check Console.");
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    };
</script>
</body>
</html>