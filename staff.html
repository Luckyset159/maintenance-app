<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f4f6f9; padding-bottom: 60px; font-family: 'Segoe UI', sans-serif; }
        .header { background: #000; color: #fff; padding: 20px; border-radius: 0 0 15px 15px; margin-bottom: 20px; position: relative; }
        .logout-btn { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; border-color: rgba(255,255,255,0.3); color: #fff; }
        .job-card { background: #fff; border-radius: 12px; border:none; border-left: 6px solid #ffc107; margin-bottom: 12px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .img-fluid { border-radius: 8px; margin-top: 10px; border: 1px solid #ddd; background: #eee; min-height: 100px; }
        .footer-bar { position: fixed; bottom: 0; width: 100%; background: #fff; border-top: 1px solid #eee; padding: 10px; text-align: center; font-size: 0.8rem; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: flex; justify-content: center; align-items: center; color: white; }
        .pin-input { font-size: 2rem; text-align: center; letter-spacing: 0.5rem; background: #222; color: #fff; border: 1px solid #444; border-radius: 10px; width: 100%; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="text-center" style="width: 300px;">
        <h2 class="mb-4 fw-bold">MAINTENANCE STAFF</h2>
        <input type="password" id="pinInput" class="pin-input" maxlength="4" inputmode="numeric" placeholder="••••">
        <button class="btn btn-outline-light w-100 py-2 fw-bold" onclick="checkPin()">UNLOCK PORTAL</button>
        <div id="loginError" class="mt-3 text-danger small" style="display:none;">Incorrect PIN.</div>
    </div>
</div>

<div id="mainContent" style="display:none;">
    <div class="header text-center">
        <button class="btn btn-sm btn-outline-light logout-btn" onclick="logout()">LOGOUT</button>
        <h4 class="mb-0">PENDING TASKS</h4>
    </div>
    <div class="container" id="jobList"><div class="text-center py-5"><div class="spinner-border"></div></div></div>
    <div class="footer-bar" id="ts">Last Refreshed: --:--</div>
</div>

<div class="modal fade" id="jobModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body">
        <h5 class="fw-bold mb-3">Job #<span id="mId"></span></h5>
        <p class="small text-muted mb-1">LOCATION</p><p class="fw-bold" id="mLoc"></p>
        <p class="small text-muted mb-1">ISSUE</p><p id="mIssue"></p>
        <div id="mImgs" class="mb-3 text-center"></div>
        <hr>
        <label class="form-label fw-bold">WORK NOTES</label>
        <textarea id="notes" class="form-control mb-3" rows="3" placeholder="Action taken..."></textarea>
        <button class="btn btn-success w-100 fw-bold" id="doneBtn" onclick="save()">COMPLETE JOB</button>
    </div></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwsFCQG0g6cLqgSBWDuAA3B8QRV_SB9CNAXMsmzb1rAYlNan6gMP9h6F_PryXta2nl3/exec"; 
    const SECRET_PIN = "4321"; // Update your PIN here

    const modal = new bootstrap.Modal(document.getElementById('jobModal'));
    let activeId = null;

    function checkPin() {
        if (document.getElementById('pinInput').value === SECRET_PIN) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            load();
        } else {
            document.getElementById('loginError').style.display = 'block';
            document.getElementById('pinInput').value = '';
        }
    }

    function logout() {
        document.getElementById('pinInput').value = '';
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
    }

    async function load() {
        try {
            const r = await fetch(WEB_APP_URL + "?action=getJobs");
            const jobs = await r.json();
            const list = document.getElementById('jobList');
            list.innerHTML = '';
            document.getElementById('ts').innerText = "Last Refreshed: " + new Date().toLocaleTimeString();
            if (jobs.length === 0) { list.innerHTML = '<div class="text-center mt-5">No pending tasks.</div>'; return; }
            jobs.forEach(j => {
                const div = document.createElement('div');
                div.className = 'card job-card p-3';
                div.onclick = () => show(j);
                div.innerHTML = `<div class="d-flex justify-content-between"><b>#${j.reqNo}</b><small>${j.date}</small></div><div>${j.area} - ${j.subarea}</div>`;
                list.appendChild(div);
            });
        } catch (e) { console.log(e); }
    }

    function show(j) {
        activeId = j.reqNo;
        document.getElementById('mId').innerText = j.reqNo;
        document.getElementById('mLoc').innerText = j.area + " / " + j.subarea;
        document.getElementById('mIssue').innerText = j.issue;
        document.getElementById('notes').value = ''; 
        
        const imgDiv = document.getElementById('mImgs');
        imgDiv.innerHTML = '';
        
        [j.pic1, j.pic2, j.pic3].forEach(url => {
            if (url) { 
                const i = document.createElement('img'); 
                i.src = url; 
                i.className = 'img-fluid w-100 mb-3';
                // Provide a placeholder if the image fails to load
                i.onerror = function() { this.src = 'https://via.placeholder.com/400x300?text=Image+Not+Found'; };
                imgDiv.appendChild(i); 
            }
        });
        modal.show();
    }

    async function save() {
        const n = document.getElementById('notes').value;
        if (!n) return alert("Please enter notes!");
        const btn = document.getElementById('doneBtn');
        btn.disabled = true; btn.innerText = "Saving...";
        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'markDone', reqNo: activeId, workNotes: n }) });
        modal.hide();
        btn.disabled = false; btn.innerText = "COMPLETE JOB";
        setTimeout(load, 1500);
    }
</script>
</body>
</html>